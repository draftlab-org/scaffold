---
import { getEntry } from 'astro:content';
import Banner from '@components/atoms/Banner.astro';
import ArticlesLanding from '@components/landing/ArticlesLanding.astro';
import PeopleLanding from '@components/landing/PeopleLanding.astro';
import PartnersLanding from '@components/landing/PartnersLanding.astro';
import ResourcesLanding from '@components/landing/ResourcesLanding.astro';
import HeroSection from '@components/sections/HeroSection.astro';
import Sections from '@components/sections/Sections.astro';
import PageLayout from '@layouts/PageLayout.astro';
import SectionLayout from '@layouts/SectionLayout.astro';
import { getPages } from '@utils/pages';
import { mapColorToVariant } from '@utils/content';

import type { GetStaticPaths } from 'astro';

// Generate static paths from pages collection (respects status visibility)
// Exclude 'home' â€” it's rendered by index.astro
export const getStaticPaths = (async () => {
  const pages = await getPages();
  return pages
    .filter((page) => page.id !== 'home')
    .map((page) => ({
      params: { path: page.id },
      props: { page },
    }));
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const siteConfig = await getEntry('site', 'config');
const archivedBanner = siteConfig?.data.archivedBanner;

// Landing components for collection index pages
const permalink = page.data.permalink;
const landingPages: Record<string, string> = {
  articles: 'articles',
  people: 'people',
  partners: 'partners',
  resources: 'resources',
};
const landingType = landingPages[permalink];
---

<PageLayout title={page.data.title} description={page.data.description}>
	{page.data.status === 'archived' && archivedBanner && (
		<Banner variant={mapColorToVariant(archivedBanner.color)} dismissible>
			{archivedBanner.message}
		</Banner>
	)}

	<SectionLayout bgImage={page.data.heroImage} sectionLabel="hero">
		<HeroSection title={page.data.title} subtitle={page.data.description} />
	</SectionLayout>

	<Sections sectionItems={page.data.sections} />

	{/* Append landing content for collection index pages */}
	{landingType === 'articles' && (
		<SectionLayout>
			<ArticlesLanding />
		</SectionLayout>
	)}
	{landingType === 'people' && (
		<SectionLayout>
			<PeopleLanding />
		</SectionLayout>
	)}
	{landingType === 'partners' && (
		<SectionLayout>
			<PartnersLanding />
		</SectionLayout>
	)}
	{landingType === 'resources' && (
		<SectionLayout>
			<ResourcesLanding />
		</SectionLayout>
	)}
</PageLayout>
