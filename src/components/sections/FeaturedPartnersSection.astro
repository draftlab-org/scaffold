---
import { getCollection } from 'astro:content';
import Button from '@components/atoms/Button.astro';
import Heading from '@components/atoms/Heading.astro';
import Image from '@components/atoms/Image.astro';
import Card from '@components/molecules/Card.astro';
import type { ImageMetadata } from 'astro';
import IconArrowRight from '~icons/heroicons/arrow-right-20-solid';
import IconExternalLink from '~icons/heroicons/arrow-top-right-on-square-20-solid';

export interface Props {
  title?: string;
  description?: string;
  partners?: string[]; // Specific partner IDs to display
  limit?: number;
  showViewAll?: boolean;
  class?: string;
}

const {
  title = 'Featured Partners',
  description,
  partners: partnerIds,
  limit = 4,
  showViewAll = false,
  class: className = '',
} = Astro.props;

// Query partners collection
const allPartners = await getCollection('partners');

// Get specific partners by ID if provided, or filter by featured flag
let selectedPartners = partnerIds
  ? allPartners.filter((p) => partnerIds.includes(p.data.id))
  : allPartners.filter((p) => (p.data as any).featured === true);

// If no featured partners found and no specific IDs, get first N partners
if (selectedPartners.length === 0 && !partnerIds) {
  selectedPartners = allPartners.slice(0, limit);
}

// Sort by order and limit
const featuredPartners = selectedPartners
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999))
  .slice(0, limit)
  .map((entry) => entry.data);
---

<div class={className}>
	{/* Section Header */}
	<div class="mb-8 flex items-end justify-between">
		<div>
			<Heading level={2} class="text-3xl">{title}</Heading>
			{description && <p class="mt-2 text-lg">{description}</p>}
		</div>
		{
			showViewAll && (
				<Button variant="ghost" size="sm" as="a" href="/partners">
					View All Partners
					<IconArrowRight class="ml-1 h-4 w-4" />
				</Button>
			)
		}
	</div>

	{/* Featured Partners Grid - Larger cards for spotlight */}
	<div class="grid gap-8 md:grid-cols-2">
		{
			featuredPartners.map((partner) => (
				<Card variant="bordered" padding="none" class="overflow-hidden">
					<div class="flex flex-col sm:flex-row">
						{/* Logo/Image */}
						{partner.image && (
							<div class="flex items-center justify-center bg-gray-50 p-8 sm:w-1/3">
								{partner.url ? (
									<a
										href={partner.url}
										target="_blank"
										rel="noopener noreferrer"
										class="block transition-transform hover:scale-105"
									>
										<Image
											src={partner.image}
											alt={partner.name}
											width={200}
											height={150}
											class="max-h-24 max-w-full object-contain"
										/>
									</a>
								) : (
									<Image
										src={partner.image}
										alt={partner.name}
										width={200}
										height={150}
										class="max-h-24 max-w-full object-contain"
									/>
								)}
							</div>
						)}

						{/* Content */}
						<div
							class={`flex flex-col justify-center p-6 ${partner.image ? 'sm:w-2/3' : 'w-full'}`}
						>
							<h3 class="mb-2 text-xl font-semibold">
								{partner.url ? (
									<a
										href={partner.url}
										target="_blank"
										rel="noopener noreferrer"
										class="underline decoration-dotted underline-offset-4 transition-colors hover:text-secondary-600 hover:decoration-solid"
									>
										{partner.name}
									</a>
								) : (
									partner.name
								)}
							</h3>

							{partner.affiliation && <p class="mb-3">{partner.affiliation}</p>}

							<p class="text-sm text-gray-500 capitalize">{partner.category}</p>

							{partner.url && (
								<a
									href={partner.url}
									target="_blank"
									rel="noopener noreferrer"
									class="mt-4 inline-flex items-center text-sm font-medium text-secondary-600 underline decoration-dotted underline-offset-4 transition-colors hover:text-secondary-700 hover:decoration-solid"
								>
									Visit website
									<IconExternalLink class="ml-1 h-4 w-4" />
								</a>
							)}
						</div>
					</div>
				</Card>
			))
		}
	</div>

	{/* Empty state */}
	{
		featuredPartners.length === 0 && (
			<div class="py-12 text-center">
				<p class="text-lg">No featured partners available.</p>
			</div>
		)
	}
</div>
