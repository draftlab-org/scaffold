---
import { getCollection } from 'astro:content';
import Button from '@components/atoms/Button.astro';
import Heading from '@components/atoms/Heading.astro';
import Image from '@components/atoms/Image.astro';
import Card from '@components/molecules/Card.astro';
import type { ImageMetadata } from 'astro';

export interface Props {
  title?: string;
  description?: string;
  partners?: string[]; // Specific partner IDs to display
  limit?: number;
  showViewAll?: boolean;
  class?: string;
}

const {
  title = 'Featured Partners',
  description,
  partners: partnerIds,
  limit = 4,
  showViewAll = false,
  class: className = '',
} = Astro.props;

// Query partners collection
const allPartners = await getCollection('partners');

// Get specific partners by ID if provided, or filter by featured flag
let selectedPartners = partnerIds
  ? allPartners.filter((p) => partnerIds.includes(p.data.id))
  : allPartners.filter((p) => (p.data as any).featured === true);

// If no featured partners found and no specific IDs, get first N partners
if (selectedPartners.length === 0 && !partnerIds) {
  selectedPartners = allPartners.slice(0, limit);
}

// Sort by order and limit
const featuredPartners = selectedPartners
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999))
  .slice(0, limit)
  .map((entry) => entry.data);
---

<div class={className}>
  {/* Section Header */}
  <div class="mb-8 flex items-end justify-between">
    <div>
      <Heading level={2} class="text-3xl">{title}</Heading>
      {description && (
        <p class="mt-2 text-lg text-gray-600">{description}</p>
      )}
    </div>
    {showViewAll && (
      <Button variant="ghost" size="sm" as="a" href="/partners">
        View All Partners
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          class="ml-1 h-4 w-4"
        >
          <path
            fill-rule="evenodd"
            d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z"
            clip-rule="evenodd"
          />
        </svg>
      </Button>
    )}
  </div>

  {/* Featured Partners Grid - Larger cards for spotlight */}
  <div class="grid gap-8 md:grid-cols-2">
    {featuredPartners.map((partner) => (
      <Card variant="bordered" padding="none" class="overflow-hidden">
        <div class="flex flex-col sm:flex-row">
          {/* Logo/Image */}
          {partner.image && (
            <div class="flex items-center justify-center bg-gray-50 p-8 sm:w-1/3">
              {partner.url ? (
                <a
                  href={partner.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="block transition-transform hover:scale-105"
                >
                  <Image
                    src={partner.image}
                    alt={partner.name}
                    width={200}
                    height={150}
                    class="max-h-24 max-w-full object-contain"
                  />
                </a>
              ) : (
                <Image
                  src={partner.image}
                  alt={partner.name}
                  width={200}
                  height={150}
                  class="max-h-24 max-w-full object-contain"
                />
              )}
            </div>
          )}

          {/* Content */}
          <div class={`flex flex-col justify-center p-6 ${partner.image ? 'sm:w-2/3' : 'w-full'}`}>
            <h3 class="mb-2 text-xl font-semibold">
              {partner.url ? (
                <a
                  href={partner.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="underline decoration-dotted underline-offset-4 transition-colors hover:text-secondary-600 hover:decoration-solid"
                >
                  {partner.name}
                </a>
              ) : (
                partner.name
              )}
            </h3>

            {partner.affiliation && (
              <p class="mb-3 text-gray-600">{partner.affiliation}</p>
            )}

            <p class="text-sm text-gray-500 capitalize">{partner.category}</p>

            {partner.url && (
              <a
                href={partner.url}
                target="_blank"
                rel="noopener noreferrer"
                class="mt-4 inline-flex items-center text-sm font-medium text-secondary-600 underline decoration-dotted underline-offset-4 transition-colors hover:text-secondary-700 hover:decoration-solid"
              >
                Visit website
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                  class="ml-1 h-4 w-4"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17h-8.5A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Z"
                    clip-rule="evenodd"
                  />
                  <path
                    fill-rule="evenodd"
                    d="M6.194 12.753a.75.75 0 0 0 1.06.053L16.5 4.44v2.81a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.553l-9.056 8.194a.75.75 0 0 0-.053 1.06Z"
                    clip-rule="evenodd"
                  />
                </svg>
              </a>
            )}
          </div>
        </div>
      </Card>
    ))}
  </div>

  {/* Empty state */}
  {featuredPartners.length === 0 && (
    <div class="py-12 text-center">
      <p class="text-lg text-gray-600">
        No featured partners available.
      </p>
    </div>
  )}
</div>
