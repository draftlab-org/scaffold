---
import { getCollection } from 'astro:content';
import Button from '@components/atoms/Button.astro';
import Heading from '@components/atoms/Heading.astro';
import Image from '@components/atoms/Image.astro';
import Tag from '@components/atoms/Tag.astro';
import Card from '@components/molecules/Card.astro';
import {
  getPublishedArticles,
  getArticlesByCategory,
  sortArticlesByDate,
  formatArticleDate,
  getArticleUrl,
} from '@utils/articles';
import { isDev } from '@utils/dev';

export interface Props {
  title?: string;
  limit?: number;
  category?: string;
  showViewAll?: boolean;
}

const {
  title = 'Latest Articles',
  limit = 3,
  category,
  showViewAll = true,
} = Astro.props;

// Fetch articles based on category filter
let articles = category
  ? await getArticlesByCategory(category)
  : await getPublishedArticles();

// Sort by date and limit
articles = sortArticlesByDate(articles, 'desc').slice(0, limit);

// Fetch all people for author lookups
const allPeople = await getCollection('people');
const peopleMap = new Map(allPeople.map((person) => [person.data.id, person.data]));

// Helper to get author names
const getAuthorNames = (authorIds: string[]) => {
  return authorIds
    .map((id) => peopleMap.get(id)?.name)
    .filter(Boolean)
    .join(', ');
};
---

<div class="py-12">
  {/* Section Header */}
  <div class="mb-8 flex items-end justify-between">
    <Heading level={2} class="text-3xl">{title}</Heading>
    {showViewAll && (
      <Button variant="ghost" size="sm" as="a" href="/articles">
        View All Articles
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          class="ml-1 h-4 w-4"
        >
          <path
            fill-rule="evenodd"
            d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z"
            clip-rule="evenodd"
          />
        </svg>
      </Button>
    )}
  </div>

  {/* Articles Grid */}
  {articles.length === 0 ? (
    <div class="py-12 text-center">
      <p class="text-lg text-gray-600">
        No articles available yet. Check back soon!
      </p>
    </div>
  ) : (
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {articles.map((article) => (
        <Card variant="bordered" class="flex h-full flex-col overflow-hidden">
          {article.data.heroImage && (
            <a href={getArticleUrl(article)} class="block">
              <Image
                src={article.data.heroImage as ImageMetadata}
                alt={article.data.title}
                width={400}
                height={225}
                class="h-48 w-full object-cover transition-transform duration-300 hover:scale-105"
              />
            </a>
          )}
          <div class="flex h-full flex-col p-6">
            {/* Draft badge (only visible in dev) */}
            {isDev && article.data.status === 'draft' && (
              <div class="mb-3">
                <Tag variant="highlight" class="font-bold">
                  DRAFT
                </Tag>
              </div>
            )}

            {/* Tags */}
            <div class="mb-3 flex flex-wrap gap-2">
              {article.data.tags.slice(0, 2).map((tag) => (
                <Tag variant="primary" size="sm">{tag}</Tag>
              ))}
            </div>

            {/* Title */}
            <h3 class="mb-3 line-clamp-2 text-xl font-semibold">
              <a
                href={getArticleUrl(article)}
                class="transition-colors hover:text-secondary-600"
              >
                {article.data.title}
              </a>
            </h3>

            {/* Metadata */}
            <div class="mb-4 space-y-1 text-sm text-gray-500">
              <p>By {getAuthorNames(article.data.authors)}</p>
              <p>{formatArticleDate(article.data.publishedDate)}</p>
            </div>

            {/* Spacer */}
            <div class="grow" />

            {/* Read More */}
            <a
              href={getArticleUrl(article)}
              class="inline-flex items-center text-sm font-medium text-secondary-600 underline decoration-dotted underline-offset-4 transition-colors hover:text-secondary-700 hover:decoration-solid"
            >
              Read more
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="ml-1 h-4 w-4"
              >
                <path
                  fill-rule="evenodd"
                  d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z"
                  clip-rule="evenodd"
                />
              </svg>
            </a>
          </div>
        </Card>
      ))}
    </div>
  )}
</div>
